<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diário de Campo - Medicina</title>
  <meta property="og:title" content="Diário de Campo - IESC">
  <meta property="og:description" content="A ferramenta pra quem precisa criar um Diário de Campo, de forma rápida e já modelada.">
  <meta property="og:image" content="https://i.ibb.co/RG93kY6V/Inserir-um-pouquinho-de-texto-3.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://thiago.med.br">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Bootstrap CSS -->
  <script src="https://cdn.tiny.cloud/1/wnknc1eopnaayokad1axrsn0koq4pgrndxu8rhd7ozx5j9sg/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blob-polyfill@7.0.20220408/Blob.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Add Tinos font for ABNT NR-37 -->
  <link href="https://fonts.googleapis.com/css2?family=Tinos&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #0ea5e9;
      --accent: #8b5cf6;
      --success: #10b981;
      --background-light: #f8fafc;
      --background-dark: #0f172a;
      --text-light: #1e293b;
      --text-dark: #f1f5f9;
      --border-light: #e2e8f0;
      --border-dark: #334155;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Tema Claro */
    body.light {
      background: linear-gradient(-45deg, #f0f9ff, #e0f2fe, #dbeafe, #ede9fe);
      color: var(--text-light);
    }

    /* Tema Escuro */
    body.dark {
      background: linear-gradient(-45deg, #020617, #1e1b4b, #1e1b4b, #020617);
      color: var(--text-dark);
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 40px;
      border-radius: 24px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .container::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 24px;
      padding: 2px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      z-index: -1;
    }

    .container.light {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .container.dark {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    #home h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    #home p {
      color: var(--text-light);
      font-size: 1.1rem;
      line-height: 1.6;
      opacity: 0.9;
    }

    .dark #home p {
      color: var(--text-dark);
    }

    #home button {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border: none;
      padding: 16px 32px;
      font-size: 1.1rem;
      border-radius: 16px;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    #home button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        120deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: 0.5s;
    }

    #home button:hover::before {
      left: 100%;
    }

    #home button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      color: inherit;
      opacity: 0.9;
    }

    input, select {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 16px;
      border: 2px solid var(--border-light);
      border-radius: 14px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    /* Estilização das opções do select */
    select option {
      background-color: var(--background-light);
      color: var(--text-light);
      padding: 12px;
    }

    .dark select option {
      background-color: var(--background-dark);
      color: var(--text-dark);
    }

    /* Estilização do select quando aberto */
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    .dark select:focus {
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
    }

    /* Cor do placeholder do select */
    select option[value=""] {
      color: rgba(0, 0, 0, 0.5);
    }

    .dark select option[value=""] {
      color: rgba(255, 255, 255, 0.5);
    }

    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #theme-toggle:hover {
      transform: rotate(45deg);
    }

    #changelogButton {
      position: fixed;
      top: 20px;
      right: 80px;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: inherit;
    }

    #changelogButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn {
      border-radius: 14px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border: none;
      color: white;
    }

    .btn-info {
      background: linear-gradient(45deg, var(--secondary), var(--accent));
      border: none;
      color: white;
    }

    .modal-content {
      border-radius: 24px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
    }

    .dark .modal-content {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-dark);
    }

    .modal-header {
      border-bottom: 1px solid rgba(229, 231, 235, 0.1);
      padding: 24px;
    }

    .modal-body {
      padding: 32px;
    }

    .feedback-btn {
      padding: 16px 28px;
      border-radius: 14px;
      font-size: 1.2rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: transparent;
      border: 2px solid var(--border-light);
    }

    .dark .feedback-btn {
      border-color: var(--border-dark);
    }

    .feedback-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .feedback-btn.active {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 16px;
      text-align: center;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.1);
    }

    .dark footer {
      background: rgba(15, 23, 42, 0.5);
    }

    /* Back button styles */
    #backButton {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }

    #backButton:hover {
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 24px;
      }

      #home h1 {
        font-size: 2.2rem;
      }

      #home button {
        font-size: 1rem;
        padding: 14px 24px;
      }

      #theme-toggle {
        top: 12px;
        right: 12px;
      }

      #changelogButton {
        top: 12px;
        right: 70px;
        font-size: 0.8rem;
        padding: 8px 16px;
      }
    }

    .hidden {
      display: none !important;
    }

    /* Animações */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      animation: fadeIn 0.5s ease-out;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: var(--secondary);
    }

    /* Preview styles */
    #preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
      margin-top: 16px;
      width: 100%;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--background-light);
    }

    .dark .preview-item {
      background: var(--background-dark);
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s ease;
      z-index: 2;
    }

    .remove-btn:hover {
      background: rgb(220, 38, 38);
      transform: scale(1.1);
    }

    /* TinyMCE customization */
    .tox-tinymce {
      border-radius: 14px !important;
      overflow: hidden;
      border: 2px solid var(--border-light) !important;
    }

    .dark .tox-tinymce {
      border-color: var(--border-dark) !important;
    }

    .dark .tox-edit-area__iframe {
      background: var(--background-dark) !important;
    }

    .dark .tox-toolbar,
    .dark .tox-statusbar {
      background: var(--background-dark) !important;
    }

    /* Modal footer fix */
    .modal-footer {
      border-top: 1px solid rgba(229, 231, 235, 0.1);
      padding: 20px;
    }

    .pdf-list {
      margin-top: 20px;
      border: 2px dashed var(--border-light);
      border-radius: 14px;
      padding: 20px;
      min-height: 200px;
    }

    .dark .pdf-list {
      border-color: var(--border-dark);
    }

    .pdf-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      border: 1px solid var(--border-light);
    }

    .dark .pdf-item {
      border-color: var(--border-dark);
    }

    .pdf-item .pdf-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pdf-item .pdf-icon {
      font-size: 24px;
      color: var(--primary);
    }

    .pdf-item .pdf-name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .pdf-item .pdf-date {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .pdf-item .remove-pdf {
      background: none;
      border: none;
      color: var(--emergency-red);
      cursor: pointer;
      font-size: 18px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .pdf-item .remove-pdf:hover {
      opacity: 1;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 1rem;
    }
    
    .btn-group .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      font-weight: 500;
    }
    
    .btn-group .btn i {
      font-size: 1.1em;
    }
    
    /* Estilos para ABNT NR-37 */
    .card-header.bg-primary {
      background: linear-gradient(45deg, var(--primary), var(--secondary)) !important;
      color: white;
    }
    
    .accordion-button:not(.collapsed) {
      background-color: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }
    
    .dark .accordion-button:not(.collapsed) {
      background-color: rgba(79, 70, 229, 0.2);
      color: var(--secondary);
    }
    
    .accordion-button:focus {
      box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
    }
    
    .fonte-item {
      transition: all 0.3s ease;
      position: relative;
    }
    
    .fonte-item:hover {
      background-color: rgba(79, 70, 229, 0.05);
      border-radius: 8px;
    }
    
    .fonte-texto {
      resize: vertical;
      min-height: 60px;
    }
    
    .dark .fonte-texto {
      background-color: var(--background-dark);
      color: var(--text-dark);
      border-color: var(--border-dark);
    }
    
    .dark .accordion-item {
      background-color: rgba(15, 23, 42, 0.8);
      color: var(--text-dark);
      border-color: var(--border-dark);
    }
    
    .dark .accordion-button {
      background-color: rgba(15, 23, 42, 0.8);
      color: var(--text-dark);
    }
    
    .dark .card {
      background-color: rgba(15, 23, 42, 0.8);
      color: var(--text-dark);
      border-color: var(--border-dark);
    }
    
    .dark .card-body {
      background-color: rgba(15, 23, 42, 0.8);
      color: var(--text-dark);
    }
    
    /* ABNT NR-37 style with Tinos font */
    .modelo-abnt {
      font-family: "Tinos", serif;
    }
  </style>
</head>
<body class="light">
  <!-- Botão de Voltar -->
  <button id="backButton" onclick="handleBack()">← Voltar</button>
  
  <!-- Botão de Troca de Tema -->
  <button id="theme-toggle">🌙</button>
  <!-- Botão de Changelogs na página inicial -->
  <button id="changelogButton" class="btn btn-sm btn-outline-secondary" style="position: absolute; top: 20px; right: 60px;" data-bs-toggle="modal" data-bs-target="#changelogModal">Changelogs</button>

  <!-- Página Inicial -->
  <div id="home" class="container light">
    <h1>Diário de Campo (Logbook)</h1>
    <p class="text-center mb-4">Crie seu relatório de vivências para o IESC!</p>
    <button class="btn btn-lg w-100 mb-3" onclick="showCreatePage()">Criar Diário de Campo</button>
    <button class="btn btn-lg w-100" onclick="showAttachPage()">Anexar Diários</button>
    <p class="text-center mt-4" style="font-size: 0.9rem;">Criado por Thiago F. Rodrigues</p>
  </div>

  <!-- Página de Anexar PDFs -->
  <div id="attach" class="container light hidden">
    <h1>Anexar Diários</h1>
    <div class="mb-4">
      <input type="file" id="pdfInput" multiple accept=".pdf" class="form-control mb-3" onchange="handlePDFUpload(event)">
      <div id="pdfPreview" class="pdf-list"></div>
    </div>
    <button class="btn btn-success" onclick="mergePDFs()">Combinar PDFs</button>
    <button class="btn btn-secondary ms-2" onclick="showHomePage()">Voltar</button>
  </div>

  <!-- Página de Criação do Diário -->
  <div id="create" class="container light hidden">
    <h1>Criar Diário de Campo</h1>
    <!-- Botão para abrir as instruções de criação do diário -->
    <button type="button" class="btn btn-info mb-3" data-bs-toggle="modal" data-bs-target="#instructionsModal">Instruções para Diário</button>
    <form id="diarioForm">
      <label for="nome">Nome do Aluno:</label>
      <input type="text" id="nome" required>

      <label for="matricula">Matrícula:</label>
      <input type="number" id="matricula" required>

      <label for="data">Data (DD/MM/AAAA):</label>
      <input type="date" id="data" required>

      <label for="local">Local de Prática:</label>
      <input type="text" id="local" required>

      <label for="professor">Professor(a):</label>
      <select id="professor" required>
        <option value="">Selecione Professor(a)</option>
        <option value="RONALD TEIXEIRA PEÇANHA FERNANDES">RONALD TEIXEIRA PEÇANHA FERNANDES</option>
        <option value="DANIELLE CECATO DE ALMEIDA PASSOS">DANIELLE CECATO DE ALMEIDA PASSOS</option>
      </select>

      <label for="semestre">Semestre:</label>
      <select id="semestre" required>
        <option value="">Selecione o Semestre</option>
        <option value="1">1º Semestre</option>
        <option value="2">2º Semestre</option>
        <option value="3">3º Semestre</option>
        <option value="4">4º Semestre</option>
        <option value="5">5º Semestre</option>
        <option value="6">6º Semestre</option>
        <option value="7">7º Semestre</option>
        <option value="8">8º Semestre</option>
        <option value="9">9º Semestre</option>
        <option value="10">10º Semestre</option>
        <option value="11">11º Semestre</option>
        <option value="12">12º Semestre</option>
      </select>

      <label for="modelo">Modelo:</label>
      <select id="modelo" required>
        <option value="Normal" selected>Normal</option>
        <option value="ABNT NR-37">ABNT NR-37</option>
      </select>

      <!-- Seção de Bibliografia (visível apenas quando ABNT NR-37 for selecionado) -->
      <div id="secaoBibliografia" class="hidden">
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Estrutura do Documento ABNT NR-37</h5>
          </div>
          <div class="card-body">
            <p class="card-text">Este formato inclui elementos adicionais conforme ABNT NBR 14724:2023:</p>
            <ul>
              <li>Fonte: Times New Roman ou Arial, tamanho 12</li>
              <li>Espaçamento: 1,5 entre linhas</li>
              <li>Alinhamento: Justificado</li>
              <li>Citações e referências: Estilo ABNT (NBR 6023 e NBR 10520)</li>
            </ul>
          </div>
        </div>

        <div class="accordion mb-3" id="abntSections">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#objetivoSection">
                Objetivo do estágio/atividade
              </button>
            </h2>
            <div id="objetivoSection" class="accordion-collapse collapse" data-bs-parent="#abntSections">
              <div class="accordion-body">
                <textarea class="form-control" id="objetivo" rows="3" placeholder="Descreva o objetivo da atividade ou estágio..."></textarea>
              </div>
            </div>
          </div>
          
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#justificativaSection">
                Justificativa
              </button>
            </h2>
            <div id="justificativaSection" class="accordion-collapse collapse" data-bs-parent="#abntSections">
              <div class="accordion-body">
                <textarea class="form-control" id="justificativa" rows="3" placeholder="Explique a importância da atividade realizada..."></textarea>
              </div>
            </div>
          </div>
          
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#contextoSection">
                Contextualização
              </button>
            </h2>
            <div id="contextoSection" class="accordion-collapse collapse" data-bs-parent="#abntSections">
              <div class="accordion-body">
                <textarea class="form-control" id="contextualizacao" rows="3" placeholder="Apresente o contexto em que a atividade foi realizada..."></textarea>
              </div>
            </div>
          </div>
          
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#metodologiaSection">
                Metodologia
              </button>
            </h2>
            <div id="metodologiaSection" class="accordion-collapse collapse" data-bs-parent="#abntSections">
              <div class="accordion-body">
                <textarea class="form-control" id="metodologia" rows="3" placeholder="Explique como foi realizada a atividade (carga horária, local, tipo de acompanhamento)..."></textarea>
              </div>
            </div>
          </div>
          
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conclusaoSection">
                Conclusão
              </button>
            </h2>
            <div id="conclusaoSection" class="accordion-collapse collapse" data-bs-parent="#abntSections">
              <div class="accordion-body">
                <textarea class="form-control" id="conclusao" rows="3" placeholder="Apresente suas conclusões gerais e competências desenvolvidas..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <label for="bibliografia">Referências Bibliográficas:</label>
        <div id="fontesContainer">
          <div class="fonte-item">
            <div class="d-flex mb-2">
              <textarea class="form-control fonte-texto" placeholder="Insira a referência bibliográfica no formato ABNT"></textarea>
              <div class="ms-2 d-flex flex-column">
                <button type="button" class="btn btn-sm btn-outline-danger mb-1 remover-fonte"><i class="fas fa-times"></i></button>
                <button type="button" class="btn btn-sm btn-outline-secondary mb-1 mover-cima" title="Mover para cima"><i class="fas fa-arrow-up"></i></button>
                <button type="button" class="btn btn-sm btn-outline-secondary mover-baixo" title="Mover para baixo"><i class="fas fa-arrow-down"></i></button>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="adicionarFonte">
          <i class="fas fa-plus"></i> Adicionar Referência
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary mt-2 ms-2" id="ordenarFontes">
          <i class="fas fa-sort-alpha-down"></i> Ordenar Alfabeticamente
        </button>
      </div>

      <label for="relatorio">Relatório de Campo:</label>
      <textarea id="relatorio" name="relatorio" required></textarea>
      <small class="text-muted d-block mt-1 mb-3">Dica: Para melhor formatação, use parágrafos curtos e evite espaçamentos excessivos. Você pode colar texto de outras fontes diretamente.</small>

      <label for="fotos">Anexar Fotos (máx. 6, atualmente <span id="imageCount">0</span>/6):</label>
      <input type="file" id="fotos" multiple accept="image/*" onchange="handleImageUpload(event)">
      <div id="preview"></div>

      <button type="button" class="btn btn-success mt-3" onclick="gerarPDF()">Finalizar</button>
    </form>
  </div>

  <!-- Modal de Instruções para Diário -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionsModalLabel">Instruções para criação de Diário</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <ul>
            <li>Este diário deve ser submetido através da plataforma CANVAS.</li>
            <li>A data do relato deve corresponder ao dia em que a atividade foi realizada, e não ao dia em que o relatório está sendo elaborado.</li>
            <li>No relato, o aluno deve redigir um texto detalhado sobre as experiências vivenciadas no respectivo dia no IESC.</li>
            <li>É necessário incluir considerações finais, objetivos alcançados durante a aula e os aprendizados significativos do dia.</li>
            <li>Fotografias podem ser anexadas, caso sejam relevantes e pertinentes à atividade realizada no dia do relato.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Changelogs -->
	<div class="modal fade" id="changelogModal" tabindex="-1" aria-labelledby="changelogModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="changelogModalLabel">Changelogs</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
		  </div>
		  <div class="modal-body">
			<div id="changelogContent">
			  <!-- Conteúdo do changelog estático -->
			  <h5>Atualizações (09/04/2025)</h5>
			  <ul>
				<li>Implementação do modelo ABNT NR-37.</li>
				<li>Melhorias no sistema geral.</li>
			  </ul>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
		  </div>
		</div>
	  </div>
	</div>
		
		<!-- Modal de Feedback -->
	<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="feedbackModalLabel">Avalie sua experiência</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
		  </div>
		  <div class="modal-body">
			<form id="feedbackForm">
			  <div class="d-flex justify-content-between mb-3">
				<button type="button" class="btn feedback-btn" data-rating="Ruim">❌</button>
				<button type="button" class="btn feedback-btn" data-rating="Normal">➖</button>
				<button type="button" class="btn feedback-btn" data-rating="Bom">✅</button>
				<button type="button" class="btn feedback-btn" data-rating="Excelente">💯</button>
			  </div>
			  
			  <div class="mb-3">
				<label for="comentario" class="form-label">O que pode melhorar na ferramenta? (opcional)</label>
				<textarea class="form-control" id="comentario" rows="2"></textarea>
			  </div>
			  
			  <div class="text-center">
				<button type="submit" class="btn btn-primary btn-sm">Enviar</button>
			  </div>
			</form>
		  </div>
		  <div class="modal-footer justify-content-center">
			<small>Criado por Thiago F. Rodrigues</small>
		  </div>
		</div>
	  </div>
	</div>


  <!-- Bibliotecas Externas -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blueimp-load-image@5.16.0/js/load-image.all.min.js"></script>

  <script>
    let selectedImages = [];
    let selectedPDFs = [];

    // Inicialização do TinyMCE
    tinymce.init({
      selector: '#relatorio',
      height: 300,
      menubar: false,
      plugins: 'lists paste autolink',
      toolbar: 'undo redo | bold italic underline | bullist numlist | alignleft aligncenter alignright alignjustify',
      paste_as_text: false,
      paste_enable_default_filters: true,
      paste_word_valid_elements: 'b,strong,i,em,h1,h2,h3,p,br',
      paste_retain_style_properties: 'none',
      paste_text_linebreaktype: 'p',
      paste_remove_styles: true,
      paste_remove_styles_if_webkit: true,
      paste_strip_class_attributes: 'all',
      browser_spellcheck: true,
      contextmenu: false,
      entity_encoding: 'raw',
      encoding: 'UTF-8',
      forced_root_block: 'p',
      init_instance_callback: function(editor) {
        const textarea = document.getElementById('relatorio');
        textarea.removeAttribute('required');
        
        document.getElementById('diarioForm').addEventListener('submit', function(e) {
          e.preventDefault();
          if (!editor.getContent().trim()) {
            alert('Por favor, preencha o relatório.');
          }
        });
      },
      setup: function(editor) {
        editor.on('init', function() {
          if (document.body.classList.contains('dark')) {
            editor.getContainer().style.backgroundColor = '#444';
            editor.getContainer().style.color = '#e9ecef';
            editor.getBody().style.backgroundColor = '#1e1e1e';
            editor.getBody().style.color = '#e9ecef';
          }
        });
        
        // Formatar texto colado automaticamente
        editor.on('BeforePaste', function(e) {
          // Decodificar o texto antes de colar
          const decoder = new TextDecoder('utf-8');
          try {
            const bytes = new Uint8Array(e.content.split('').map(c => c.charCodeAt(0)));
            e.content = decoder.decode(bytes);
          } catch (error) {
            console.error('Erro ao decodificar:', error);
          }
        });

        editor.on('PastePreProcess', function(e) {
          let content = e.content;
          
          // Converter entidades HTML para caracteres
          content = content.replace(/&([^;]+);/g, function(entity, entityCode) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = entity;
            return textarea.value;
          });

          // Limpar formatação excessiva
          content = content
            .replace(/<p>\s*<\/p>/g, '') // Remove parágrafos vazios
            .replace(/\n\s*\n/g, '\n') // Remove linhas em branco extras
            .replace(/(<br\s*\/?>){3,}/gi, '<br /><br />'); // Limita quebras de linha consecutivas

          e.content = content;
        });

        editor.on('paste', function(e) {
          setTimeout(function() {
            let content = editor.getContent();
            
            // Garantir que o conteúdo está em UTF-8
            content = decodeURIComponent(escape(content));
            
            // Remover caracteres inválidos e substituir por seus equivalentes corretos
            content = content
              .replace(/[\u0080-\u00ff]/g, function(char) {
                return String.fromCharCode(char.charCodeAt(0) & 0xFF);
              })
              .replace(/[^\x00-\x7F]/g, function(char) {
                return char;
              });

            editor.setContent(content);
          }, 100);
        });
        
        // Adicionar atalho para colar como texto simples
        editor.addShortcut('ctrl+shift+v', 'Colar como texto', function() {
          editor.execCommand('mceTogglePlainTextPaste');
        });
      },
      content_style: `
        body { 
          font-family: 'Plus Jakarta Sans', sans-serif; 
          line-height: 1.6;
          font-size: 14px;
        }
        body.dark { 
          background-color: #1e1e1e; 
          color: #e9ecef; 
        }
        p { 
          margin: 0 0 0.75em 0; 
          line-height: 1.5; 
        }
        ul, ol { 
          margin-bottom: 0.75em; 
        }
        li { 
          margin-bottom: 0.25em; 
        }
      `
    });

    // Remover o evento de carregamento do logo
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.add('hidden');
      toggleTheme(); // Configura o tema inicial
    });

    function showHomePage() {
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.add('hidden');
      document.getElementById('footer').style.display = 'block';
    }

    function showCreatePage() {
      document.getElementById('home').classList.add('hidden');
      document.getElementById('create').classList.remove('hidden');
      document.getElementById('attach').classList.add('hidden');
      document.getElementById('footer').style.display = 'none';
    }

    function showAttachPage() {
      document.getElementById('home').classList.add('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.remove('hidden');
      document.getElementById('footer').style.display = 'none';
    }

    function handleImageUpload(event) {
      const files = Array.from(event.target.files);
      if (selectedImages.length + files.length > 6) {
        alert("Você pode selecionar no máximo 6 imagens.");
        event.target.value = ''; // Limpa a seleção
        return;
      }
      selectedImages = [...selectedImages, ...files];
      renderPreview();
    }
	
		async function loadImageAsync(file) {
		  return new Promise((resolve, reject) => {
			loadImage(
			  file,
			  (imgOrCanvas) => {
				const img = document.createElement('img');
				img.src = imgOrCanvas.toDataURL(file.type);
				resolve(img);
			  },
			  {
				orientation: true,
				canvas: true,
				meta: true
			  }
			);
		  });
		}
		
		function createPreviewItem(img, index) {
		  const item = document.createElement('div');
		  item.className = 'preview-item';
		  
		  img.style.maxWidth = '100%';
		  img.style.height = 'auto';
		  item.appendChild(img);

		  const removeBtn = document.createElement('button');
		  removeBtn.className = 'remove-btn';
		  removeBtn.textContent = 'X';
		  removeBtn.onclick = () => removeImage(index);
		  item.appendChild(removeBtn);

		  return item;
		}
		
		async function processImageForPDF(file) {
		  return new Promise((resolve, reject) => {
			loadImage(
			  file,
			  (canvas) => {
				try {
				  // Definir dimensões máximas para fotos no PDF
				  const maxWidth = 600;
				  const maxHeight = 450;
				  
				  // Obter dimensões originais
				  let width = canvas.width;
				  let height = canvas.height;
				  
				  // Calcular proporção para redimensionamento
				  const aspectRatio = width / height;
				  
				  // Redimensionar mantendo proporção
				  if (width > maxWidth) {
					width = maxWidth;
					height = Math.round(width / aspectRatio);
				  }
				  
				  if (height > maxHeight) {
					height = maxHeight;
					width = Math.round(height * aspectRatio);
				  }
				  
				  // Criar canvas redimensionado
				  const resizedCanvas = document.createElement('canvas');
				  resizedCanvas.width = width;
				  resizedCanvas.height = height;
				  
				  // Desenhar imagem redimensionada
				  const ctx = resizedCanvas.getContext('2d');
				  ctx.fillStyle = 'white'; // Fundo branco para imagens com transparência
				  ctx.fillRect(0, 0, width, height);
				  ctx.drawImage(canvas, 0, 0, width, height);
				  
				  // Converter para dataURL com qualidade otimizada
				  // Usar qualidade 0.8 (80%) para JPEG para equilibrar tamanho e qualidade
				  const dataURL = resizedCanvas.toDataURL('image/jpeg', 0.8);
				  
				  // Adicionar informações de dimensão
				  resolve({
					dataURL: dataURL,
					width: width,
					height: height
				  });
				} catch (error) {
				  console.error('Erro ao processar imagem:', error);
				  reject(error);
				}
			  },
			  {
				orientation: true, // Corrigir orientação da imagem
				canvas: true,      // Retornar um canvas
				maxWidth: 1200,    // Limitar dimensão máxima inicial
				maxHeight: 1200,   // Limitar dimensão máxima inicial
				crop: false,       // Não recortar
				meta: true         // Preservar metadados
			  }
			);
		  });
		}

	async function renderPreview() {
	  const preview = document.getElementById('preview');
	  preview.innerHTML = '';
	  
	  for (const [index, file] of selectedImages.entries()) {
		try {
		  const img = await loadImageAsync(file);
		  const item = createPreviewItem(img, index);
		  preview.appendChild(item);
		} catch (error) {
		  console.error('Error ao carregar a imagem:', error);
		}
	  }
	  updateImageCount();
	}

    function removeImage(index) {
      selectedImages.splice(index, 1);
      renderPreview();
    }

    function updateImageCount() {
      document.getElementById('imageCount').textContent = selectedImages.length;
    }

    // Função para alternar tema
	function toggleTheme() {
	  const body = document.body;
	  const containers = document.querySelectorAll('.container');
	  const toggleButton = document.getElementById('theme-toggle');
	  const modals = document.querySelectorAll('.modal-content');

	  if (body.classList.contains('light')) {
		// Tema Escuro
		body.classList.replace('light', 'dark');
		containers.forEach(container => container.classList.replace('light', 'dark'));
		modals.forEach(modal => {
		  modal.classList.replace('light', 'dark');
		  modal.style.backgroundColor = '#2c3e50';
		  modal.style.color = '#e9ecef';
		});
		toggleButton.textContent = '☀️';
		
		// Ajustar TinyMCE
		if (tinymce.activeEditor) {
		  tinymce.activeEditor.getContainer().style.backgroundColor = '#444';
		  tinymce.activeEditor.getContainer().style.color = '#e9ecef';
		  tinymce.activeEditor.getBody().style.backgroundColor = '#1e1e1e';
		  tinymce.activeEditor.getBody().style.color = '#e9ecef';
		}
	  } else {
		// Tema Claro
		body.classList.replace('dark', 'light');
		containers.forEach(container => container.classList.replace('dark', 'light'));
		modals.forEach(modal => {
		  modal.classList.replace('dark', 'light');
		  modal.style.backgroundColor = '#fff';
		  modal.style.color = '#2c3e50';
		});
		toggleButton.textContent = '🌙';
		
		// Ajustar TinyMCE
		if (tinymce.activeEditor) {
		  tinymce.activeEditor.getContainer().style.backgroundColor = '#fff';
		  tinymce.activeEditor.getContainer().style.color = '#2c3e50';
		  tinymce.activeEditor.getBody().style.backgroundColor = '#fff';
		  tinymce.activeEditor.getBody().style.color = '#2c3e50';
		}
	  }
	}

    // Evento do botão de tema
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    async function gerarPDF() {
        // Verificar se o pdfMake está carregado
      if (typeof pdfMake === 'undefined') {
            alert('Erro: Biblioteca pdfMake não carregada. Por favor, recarregue a página.');
        return;
      }

        // Verificar quais fontes estão disponíveis no pdfMake
        console.log("Fontes disponíveis no pdfMake:", pdfMake.fonts || "Nenhuma fonte personalizada definida");
        
        // Valores dos campos
        const nome = document.getElementById('nome').value;
        const matricula = document.getElementById('matricula').value;
      const data = document.getElementById('data').value;
        const local = document.getElementById('local').value;
      const professor = document.getElementById('professor').value;
      const semestre = document.getElementById('semestre').value;
        const modelo = document.getElementById('modelo').value;
        
        // Obter o conteúdo do relatorio do TinyMCE
        const editorContent = tinymce.get('relatorio').getContent();
        
        // Limpar o conteúdo HTML para ser compatível com o PDF
        const relatorio = limparConteudoHTML(editorContent);
        
        // Verificar se todos os campos necessários estão preenchidos
        if (!nome || !matricula || !data || !local || !professor || !semestre || !relatorio) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        // Mostrar indicador de carregamento
        const loadingElement = document.createElement('div');
        loadingElement.className = 'alert alert-info mt-3';
        loadingElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF, por favor aguarde...';
        document.getElementById('diarioForm').appendChild(loadingElement);
        
        try {
            // Array para armazenar as fontes bibliográficas (se houver)
            let fontesBibliograficas = [];
            
            // Variáveis para as seções ABNT
            let objetivo = '';
            let justificativa = '';
            let contextualizacao = '';
            let metodologia = '';
            let conclusao = '';
            
            // Se o modelo for ABNT NR-37, obter os valores das seções específicas
            if (modelo === 'ABNT NR-37') {
                try {
                    // Verificar se o elemento existe antes de obter seu valor
                    const objetivoElement = document.getElementById('objetivo');
                    if (objetivoElement) {
                        objetivo = objetivoElement.value;
                    }
                    
                    const justificativaElement = document.getElementById('justificativa');
                    if (justificativaElement) {
                        justificativa = justificativaElement.value;
                    }
                    
                    const contextualizacaoElement = document.getElementById('contextualizacao');
                    if (contextualizacaoElement) {
                        contextualizacao = contextualizacaoElement.value;
                    }
                    
                    const metodologiaElement = document.getElementById('metodologia');
                    if (metodologiaElement) {
                        metodologia = metodologiaElement.value;
                    }
                    
                    const conclusaoElement = document.getElementById('conclusao');
                    if (conclusaoElement) {
                        conclusao = conclusaoElement.value;
                    }
                    
                    // Obter as fontes bibliográficas
                    const fontesContainer = document.getElementById('fontesContainer');
                    if (fontesContainer) {
                        const fonteTextareas = fontesContainer.querySelectorAll('.fonte-texto');
                        fonteTextareas.forEach(textarea => {
                            if (textarea.value.trim() !== '') {
                                fontesBibliograficas.push(textarea.value.trim());
                            }
                        });
                    }
                } catch (error) {
                    console.error('Erro ao processar seções ABNT:', error);
                }
            }
            
            // Definir os estilos do documento
            const estilos = {
                header: {
                    fontSize: 18,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 0, 0, 20]
                },
                subheader: {
                    fontSize: 16,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 5]
                },
                normal: {
                    fontSize: 12,
                    margin: [0, 5, 0, 10]
                },
                sectionHeader: {
                    fontSize: 14,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 5]
                },
                paragraph: {
                    fontSize: 12,
                    alignment: 'justify',
                    lineHeight: 1.5
                },
                list: {
                    fontSize: 12,
                    margin: [20, 0, 0, 10]
                },
                footer: {
                    fontSize: 10,
                    italic: true,
                    color: 'gray',
                    alignment: 'right',
                    margin: [0, 0, 20, 20]
                }
            };
            
            // Se o modelo for ABNT NR-37, adicionar estilos específicos
            if (modelo === 'ABNT NR-37') {
                estilos.abntTitle = {
                    fontSize: 16,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 20, 0, 20]
                };
                estilos.abntSection = {
                    fontSize: 14,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 15, 0, 10]
                };
                estilos.abntText = {
                    fontSize: 12,
                    margin: [0, 5, 0, 10],
                    alignment: 'justify',
                    lineHeight: 1.5
                };
                estilos.abntReference = {
                    fontSize: 11,
                    margin: [0, 3, 0, 3],
                    alignment: 'left'
                };
            }

            // Criar conteúdo base para o PDF
            const conteudoPDF = [
                // Página 1 - Capa
          {
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'A seguir uma apresentação do relato de vivências.',
                style: 'subheader',
                alignment: 'center',
                margin: [0, 0, 0, 20]
              },
              {
                            text: `Data: ${formatarData(data)}`,
                            style: 'normal',
                margin: [0, 0, 0, 10]
              },
              {
                text: '1. Informações institucionais;',
                            style: 'normal',
                margin: [0, 0, 0, 5]
              },
              {
                text: '2. Identificação e detalhes.',
                            style: 'normal',
                margin: [0, 0, 0, 10]
              },
              {
                canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }],
                margin: [0, 0, 0, 20]
              },
              {
                text: 'INSTITUIÇÃO',
                style: 'sectionHeader',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'Universidade Unigranrio - Afya - Campus Barra da Tijuca',
                            style: 'normal',
                margin: [0, 0, 0, 5]
              },
              {
                text: 'Av. Ayrton Senna, 2.200 – Barra da Tijuca, Rio de Janeiro - RJ, 22775-003',
                            style: 'normal',
                margin: [0, 0, 0, 20]
              },
              {
                text: 'IDENTIFICAÇÃO & DETALHES',
                style: 'sectionHeader',
                margin: [0, 0, 0, 10]
              },
              {
                ul: [
        `Nome: ${nome}`,
        `Matrícula: ${matricula}`,
                  'Curso: Medicina',
                  'Turno: Integral',
                                `Semestre: ${semestre}º Semestre de ${data.split('-')[0]}`,
                  'Disciplina: IESC (Integração Ensino-Serviço-Comunidade)',
        `Local de Prática: ${local}`,
                                `Professor(a): ${professor}`
                ],
                style: 'list',
                margin: [0, 0, 0, 20]
              }
            ],
            pageBreak: 'after'
          },
          
                // Página 2 - Relatório
          {
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                            text: `Data: ${formatarData(data)}`,
                            style: 'normal',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'TEXTO RELATORIAL',
                style: 'sectionHeader',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                            // Usar uma tabela para manter o texto dentro do retângulo e garantir que fiquem na mesma página
                            table: {
                                widths: ['*'],
                                heights: [580],
                                body: [
                                    [{
                                        text: relatorio,
                                        style: 'paragraph',
                                        margin: [5, 5, 5, 5]
                                    }]
                                ]
                            },
                            layout: {
                                hLineWidth: function(i, node) { return 1; },
                                vLineWidth: function(i, node) { return 1; },
                                hLineColor: function(i, node) { return '#000000'; },
                                vLineColor: function(i, node) { return '#000000'; },
                            },
                            margin: [0, 0, 0, 20]
                        }
                    ],
                    pageBreak: selectedImages.length > 0 ? 'after' : undefined
                }
            ];
            
            // Adicionar páginas específicas para ABNT NR-37 se necessário
            if (modelo === 'ABNT NR-37') {
                // Vamos diretamente para objetivos e justificativa sem a página de elementos pré-textuais
                if (objetivo || justificativa) {
                    // Adicionar página para objetivos e justificativa
                    const objetivoJustificativaStack = [
                        {
                            text: 'OBJETIVOS E JUSTIFICATIVA',
                            style: 'abntTitle',
                            alignment: 'center',
                margin: [0, 0, 0, 20]
                        }
                    ];
                    
                    if (objetivo) {
                        objetivoJustificativaStack.push(
                            {
                                text: 'OBJETIVO DO ESTÁGIO/ATIVIDADE',
                                style: 'abntSection',
                                margin: [0, 0, 0, 10]
                            },
                            {
                                text: objetivo,
                                style: 'abntText',
                                margin: [0, 0, 0, 20]
                            }
                        );
                    }
                    
                    if (justificativa) {
                        objetivoJustificativaStack.push(
                            {
                                text: 'JUSTIFICATIVA',
                                style: 'abntSection',
                                margin: [0, 0, 0, 10]
                            },
                            {
                                text: justificativa,
                                style: 'abntText',
                                margin: [0, 0, 0, 20]
                            }
                        );
                    }
                    
                    conteudoPDF.push({
                        stack: objetivoJustificativaStack,
                        pageBreak: 'after'
                    });
                }
                
                // Adicionar página para contextualização e metodologia
                if (contextualizacao || metodologia) {
                    const contextoMetodologiaStack = [
                        {
                            text: 'CONTEXTUALIZAÇÃO E METODOLOGIA',
                            style: 'abntTitle',
                            alignment: 'center',
                            margin: [0, 0, 0, 20]
                        }
                    ];
                    
                    if (contextualizacao) {
                        contextoMetodologiaStack.push(
                            {
                                text: 'CONTEXTUALIZAÇÃO',
                                style: 'abntSection',
            margin: [0, 0, 0, 10]
          },
                            {
                                text: contextualizacao,
                                style: 'abntText',
                                margin: [0, 0, 0, 20]
                            }
                        );
                    }
                    
                    if (metodologia) {
                        contextoMetodologiaStack.push(
                            {
                                text: 'METODOLOGIA',
                                style: 'abntSection',
            margin: [0, 0, 0, 10]
          },
                            {
                                text: metodologia,
                                style: 'abntText',
                                margin: [0, 0, 0, 20]
                            }
                        );
                    }
                    
                    conteudoPDF.push({
                        stack: contextoMetodologiaStack,
                        pageBreak: 'after'
                    });
                }
                
                // Adicionar página para conclusão
                if (conclusao) {
                    conteudoPDF.push({
                        stack: [
                            {
                                text: 'CONCLUSÃO',
                                style: 'abntTitle',
                                alignment: 'center',
                                margin: [0, 0, 0, 20]
                            },
                            {
                                text: conclusao,
                                style: 'abntText',
                                margin: [0, 0, 0, 20]
                            }
                        ],
                        pageBreak: 'after'
                    });
                }
                
                // Adicionar página para referências bibliográficas
                if (fontesBibliograficas.length > 0) {
                    // Criar array com elementos para a página de bibliografia
                    const refStack = [
                        {
                            text: 'BIBLIOGRAFIA FUNDAMENTAL & FUNDAMENTAÇÃO TEÓRICA',
                            style: 'abntTitle',
                            alignment: 'center',
                            margin: [0, 0, 0, 20]
                        },
                        {
                            text: 'REFERÊNCIAS BIBLIOGRÁFICAS',
                            style: 'abntSection',
                            margin: [0, 0, 0, 15]
                        }
                    ];
                    
                    // Adicionar cada referência bibliográfica individualmente
                    for (let i = 0; i < fontesBibliograficas.length; i++) {
                        refStack.push({
                            text: `[${i+1}] ${fontesBibliograficas[i]}`,
                            style: 'abntReference',
                            alignment: 'left',
                            margin: [0, 0, 0, 10]
                        });
                    }
                    
                    // Adicionar a página ao documento
                    conteudoPDF.push({
                        stack: refStack,
                        pageBreak: selectedImages.length > 0 ? 'after' : undefined
                    });
                }
            }
            
            // Processar imagens para o PDF
            if (selectedImages.length > 0) {
                // Criar tabela para as imagens
                const imageRows = [];
        let currentRow = [];
        
                // Processar cada imagem selecionada
                for (let i = 0; i < selectedImages.length; i++) {
                    try {
                        // Processar a imagem para o formato adequado para o PDF
                        const processedImage = await processImageForPDF(selectedImages[i]);
                        
                        // Adicionar a imagem processada ao array atual
                        currentRow.push({
                            image: processedImage.dataURL,
                            width: Math.min(processedImage.width, 160),  // Limitar a largura máxima
                            height: Math.min(processedImage.height, 160), // Limitar a altura máxima
                            fit: [150, 150],                             // Ajustar dentro destes limites
                            alignment: 'center',
                            margin: [10, 10, 10, 10],
                            border: [false, false, false, false]
                        });
                        
                        // Completar a linha ou criar uma nova se necessário
                        if (currentRow.length === 3 || i === selectedImages.length - 1) {
                            // Preencher lacunas para manter o layout
            while (currentRow.length < 3) {
              currentRow.push({});
            }
                            
                            // Adicionar a linha à tabela e resetar
                            imageRows.push(currentRow);
            currentRow = [];
                        }
                    } catch (error) {
                        console.error(`Erro ao processar imagem ${i}:`, error);
          }
        }
        
                // Adicionar página de imagens ao PDF
                conteudoPDF.push({
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                            text: `Data: ${formatarData(data)}`,
                            style: 'normal',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'FOTOGRAFIAS DA ATIVIDADE',
                style: 'sectionHeader',
                alignment: 'center',
                margin: [0, 0, 0, 20]
              },
              {
                table: {
                  widths: ['*', '*', '*'],
                                body: imageRows
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
              }
            ]
                });
            }

            // Formatar a data para o nome do arquivo
            const dataFormatada = formatarData(data, '-');
            const fileName = `Diário de Campo - ${dataFormatada}.pdf`;
            
            // Definir o documento
            const docDefinition = {
                // Configurar margens de acordo com o modelo
                pageMargins: modelo === 'ABNT NR-37' ? [72, 72, 72, 72] : [40, 40, 40, 40],
                
                // Estilo padrão
                defaultStyle: {
                    fontSize: modelo === 'ABNT NR-37' ? 11 : 12,
                    lineHeight: modelo === 'ABNT NR-37' ? 1.5 : 1.2
                },
                
                // Estilos definidos anteriormente
                styles: estilos,
                
                // Conteúdo do PDF
                content: conteudoPDF,
                
                // Adicionar função de rodapé para números de página
                footer: function(currentPage, pageCount) {
                    return {
                        text: currentPage > 1 ? `${currentPage}` : '',
                        alignment: 'right',
                        margin: [0, 0, 40, 20],
                        fontSize: 10,
                        italic: true,
                        color: 'gray'
                    };
                },
                
                // Formatação do conteúdo HTML
                html: {
                    // Remover formatação excessiva do conteúdo HTML
                    preprocessors: [
                        (html) => html.replace(/<p>\s*<\/p>/g, '')
                    ]
                }
            };
            
            // Configurar a geração do PDF para garantir que os elementos fiquem centralizados
            if (modelo === 'ABNT NR-37') {
                // Ajustar margens para criar um layout mais equilibrado e formal
                docDefinition.pageMargins = [80, 80, 80, 80];
                
                // Adicionar propriedade de alinhamento para centralizar todo o conteúdo das páginas ABNT
                conteudoPDF.forEach(page => {
                    if (page.stack && Array.isArray(page.stack)) {
                        // Para cada elemento no stack, garantir que títulos e seções estão centralizados
                        page.stack.forEach(item => {
                            if (item.style === 'abntTitle' || item.style === 'abntSection') {
                                item.alignment = 'center';
                            }
                        });
                    }
                });
            }
            
            // Gerar o PDF
            pdfMake.createPdf(docDefinition).download(fileName);
            
            // Mostrar feedback de sucesso
            loadingElement.className = 'alert alert-success mt-3';
            loadingElement.innerHTML = '<i class="fas fa-check-circle"></i> PDF gerado com sucesso!';
            
            // Remover o feedback após alguns segundos
          setTimeout(() => {
                if (loadingElement.parentNode) {
                    loadingElement.parentNode.removeChild(loadingElement);
            }
          
                // Mostrar modal de feedback após gerar o PDF
		showFeedbackWithDelay();
            }, 3000);
        
      } catch (error) {
            console.error('Erro ao gerar PDF:', error);
            
            // Mostrar feedback de erro
            loadingElement.className = 'alert alert-danger mt-3';
            loadingElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro ao gerar o PDF. Por favor, tente novamente.';
            
            // Remover o feedback após alguns segundos
        setTimeout(() => {
                if (loadingElement.parentNode) {
                    loadingElement.parentNode.removeChild(loadingElement);
                }
            }, 5000);
        }
    }

    // Função auxiliar para formatar a data
    function formatarData(dataISO, separator = '/') {
        if (!dataISO) return '';
        const partes = dataISO.split('-');
        if (partes.length !== 3) return dataISO;
        
        // Formato DD/MM/AAAA ou DD-MM-AAAA dependendo do separador
        return `${partes[2]}${separator}${partes[1]}${separator}${partes[0]}`;
    }

    // Função para limpar o conteúdo HTML do editor e torná-lo compatível com o PDF
    function limparConteudoHTML(html) {
        // Se não houver conteúdo, retornar string vazia
        if (!html || html.trim() === '') {
            return '';
        }
        
        // Criar um elemento temporário
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Processar parágrafos e outros elementos
        const paragrafos = temp.querySelectorAll('p, div, span, h1, h2, h3, h4, h5, h6');
        paragrafos.forEach(p => {
            // Remover estilos inline que possam conflitar com o PDF
            p.removeAttribute('style');
            p.removeAttribute('class');
            p.removeAttribute('id');
            
            // Se for um parágrafo vazio, remover
            if (p.textContent.trim() === '' && !p.querySelector('img, br')) {
                p.remove();
            }
        });
        
        // Processar listas
        const listas = temp.querySelectorAll('ul, ol');
        listas.forEach(lista => {
            lista.removeAttribute('style');
            lista.removeAttribute('class');
            lista.removeAttribute('id');
        });
        
        // Processar itens de lista
        const itensLista = temp.querySelectorAll('li');
        itensLista.forEach(item => {
            item.removeAttribute('style');
            item.removeAttribute('class');
            item.removeAttribute('id');
        });
        
        // Remover elementos vazios que não sejam quebras de linha
        const elementosVazios = temp.querySelectorAll('div:empty, p:empty, span:empty');
        elementosVazios.forEach(el => {
            if (el.tagName.toLowerCase() !== 'br') {
                el.remove();
            }
        });
        
        // Converter o conteúdo de volta para string
        let textoLimpo = temp.innerHTML;
        
        // Substituir entidades HTML por seus caracteres correspondentes
        const entidadesHTML = {
            '&nbsp;': ' ',
            '&lt;': '<',
            '&gt;': '>',
            '&amp;': '&',
            '&quot;': '"',
            '&apos;': "'",
            '&cent;': '¢',
            '&pound;': '£',
            '&yen;': '¥',
            '&euro;': '€',
            '&copy;': '©',
            '&reg;': '®',
            '&trade;': '™'
        };
        
        // Substituir todas as entidades HTML conhecidas
        Object.entries(entidadesHTML).forEach(([entidade, caractere]) => {
            const regex = new RegExp(entidade, 'g');
            textoLimpo = textoLimpo.replace(regex, caractere);
        });
        
        // Converter tags HTML para o formato do pdfMake
        textoLimpo = textoLimpo
            // Substituir quebras de linha
            .replace(/<br\s*\/?>/gi, '\n')
            // Substituir parágrafos
            .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n')
            // Substituir divs
            .replace(/<div[^>]*>(.*?)<\/div>/gi, '$1\n')
            // Substituir itens de lista
            .replace(/<li[^>]*>(.*?)<\/li>/gi, '  • $1\n')
            // Remover formatação de negrito, mas manter conteúdo
            .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '$1')
            .replace(/<b[^>]*>(.*?)<\/b>/gi, '$1')
            // Remover formatação de itálico, mas manter conteúdo
            .replace(/<em[^>]*>(.*?)<\/em>/gi, '$1')
            .replace(/<i[^>]*>(.*?)<\/i>/gi, '$1')
            // Remover formatação de sublinhado, mas manter conteúdo
            .replace(/<u[^>]*>(.*?)<\/u>/gi, '$1')
            // Substituir cabeçalhos
            .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '$1\n')
            .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '$1\n')
            .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '$1\n')
            .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '$1\n')
            .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '$1\n')
            .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '$1\n')
            // Remover quaisquer outras tags
            .replace(/<[^>]*>/g, '')
            // Remover linhas em branco consecutivas
            .replace(/\n\s*\n/g, '\n')
            // Remover espaços em branco no início e fim
            .trim();
        
        // Decodificar caracteres especiais ou entidades HTML restantes
        try {
            textoLimpo = decodeURIComponent(escape(textoLimpo));
        } catch (e) {
            console.warn('Erro ao decodificar texto:', e);
        }
        
        return textoLimpo;
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
	
	function showFeedbackWithDelay() {
	  setTimeout(() => {
		const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
		feedbackModal.show();
	  }, 1200); // 1.2 segundos de delay
	}

    async function fetchLastUpdate() {
      try {
        const response = await fetch('https://api.github.com/repos/thixgor/Projetos-Acad-micos/commits');
        const commits = await response.json();
        if (commits.length > 0) {
          const lastCommitDate = new Date(commits[0].commit.author.date).toLocaleString('pt-BR');
          document.getElementById('last-update').textContent = lastCommitDate;
        }
      } catch (error) {
        document.getElementById('last-update').textContent = 'Erro ao carregar data';
      }
    }
    fetchLastUpdate();

		// Feedback Handling
	let selectedRating = '';

	document.querySelectorAll('.feedback-btn').forEach(button => {
	  button.addEventListener('click', function() {
		selectedRating = this.dataset.rating;
		document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('active'));
		this.classList.add('active');
	  });
	});

	document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
	  e.preventDefault();
	  
	  const comentario = document.getElementById('comentario').value;
	  const nome = document.getElementById('nome').value.trim();
	  
	  const formData = new FormData();
	  formData.append('entry.85766025', comentario);
	  formData.append('entry.1074346290', nome);
	  formData.append('entry.305852309', selectedRating);
	  
	  try {
		await fetch('https://docs.google.com/forms/d/e/1FAIpQLSfyuOVVkmDGATCm3CiIe3YjG9_jSdMlhj-OfZaosEXsvulN1w/formResponse', {
		  method: 'POST',
		  body: formData,
		  mode: 'no-cors'
		});
		
		// Fechar modal após envio
		bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
		alert('Obrigado pelo seu feedback! 😊');
	  } catch (error) {
		alert('Erro ao enviar feedback. Tente novamente mais tarde.');
	  }
	});

    function handlePDFUpload(event) {
      const files = Array.from(event.target.files);
      
      // Process each file
      files.forEach(file => {
        if (file.name.startsWith('Diário de Campo - ')) {
          const dateStr = file.name.match(/\d{2}-\d{2}-\d{4}/)[0];
          const version = file.name.match(/\(\d+\)/) ? parseInt(file.name.match(/\(\d+\)/)[0].replace(/[()]/g, '')) : 0;
          
          // Check if we already have a file with this date
          const existingIndex = selectedPDFs.findIndex(pdf => pdf.date === dateStr);
          
          if (existingIndex === -1 || version > selectedPDFs[existingIndex].version) {
            const pdfInfo = {
              file: file,
              date: dateStr,
              version: version,
              name: file.name
            };
            
            if (existingIndex !== -1) {
              selectedPDFs[existingIndex] = pdfInfo;
            } else {
              selectedPDFs.push(pdfInfo);
            }
          }
        }
      });
      
      // Sort PDFs by date
      selectedPDFs.sort((a, b) => {
        const dateA = new Date(a.date.split('-').reverse().join('-'));
        const dateB = new Date(b.date.split('-').reverse().join('-'));
        return dateA - dateB;
      });
      
      renderPDFPreview();
    }

    function renderPDFPreview() {
      const preview = document.getElementById('pdfPreview');
      preview.innerHTML = '';
      
      if (selectedPDFs.length === 0) {
        preview.innerHTML = '<p class="text-center text-muted mt-4">Nenhum PDF selecionado</p>';
        return;
      }
      
      selectedPDFs.forEach((pdf, index) => {
        const item = document.createElement('div');
        item.className = 'pdf-item';
        item.innerHTML = `
          <div class="pdf-info">
            <span class="pdf-icon">📄</span>
            <div>
              <div class="pdf-name">${pdf.name}</div>
              <div class="pdf-date">${pdf.date}</div>
            </div>
          </div>
          <button class="remove-pdf" onclick="removePDF(${index})">×</button>
        `;
        preview.appendChild(item);
      });
    }

    function removePDF(index) {
      selectedPDFs.splice(index, 1);
      renderPDFPreview();
    }

    async function mergePDFs() {
      if (selectedPDFs.length === 0) {
        alert('Por favor, selecione pelo menos um PDF para combinar.');
        return;
      }

      try {
        // Certifique-se de que a biblioteca PDF-LIB está disponível
        const PDFLib = window.PDFLib || window.pdfjsLib;
        if (!PDFLib) {
          alert('Erro: A biblioteca PDF-LIB não foi carregada corretamente. Verifique sua conexão com a internet.');
        return;
      }

      const { PDFDocument } = PDFLib;
      const mergedPdf = await PDFDocument.create();
      
        // Mostrar indicador de progresso
        const preview = document.getElementById('pdfPreview');
        const progressDiv = document.createElement('div');
        progressDiv.className = 'alert alert-info';
        progressDiv.textContent = 'Combinando PDFs... Por favor, aguarde.';
        preview.appendChild(progressDiv);
        
        for (const pdfInfo of selectedPDFs) {
          try {
          const pdfBytes = await pdfInfo.file.arrayBuffer();
          const pdf = await PDFDocument.load(pdfBytes);
          const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          copiedPages.forEach((page) => mergedPdf.addPage(page));
            
            // Atualizar progresso
            progressDiv.textContent = `Processando: ${pdfInfo.name}`;
          } catch (error) {
            console.error(`Erro ao processar o PDF ${pdfInfo.name}:`, error);
            // Continuar com o próximo PDF
          }
        }
        
        // Remover indicador de progresso
        preview.removeChild(progressDiv);
        
        const mergedPdfFile = await mergedPdf.save();
        const blob = new Blob([mergedPdfFile], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Diário de Campo Completo.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('PDFs combinados com sucesso!');
      } catch (error) {
        console.error('Erro ao combinar PDFs:', error);
        alert('Ocorreu um erro ao combinar os PDFs. Por favor, tente novamente.');
      }
    }

    function handleBack() {
      const homeVisible = !document.getElementById('home').classList.contains('hidden');
      const createVisible = !document.getElementById('create').classList.contains('hidden');
      const attachVisible = !document.getElementById('attach').classList.contains('hidden');

      if (homeVisible) {
        window.location.href = 'https://thiago.med.br/ferramentas';
      } else if (createVisible || attachVisible) {
        showHomePage();
      }
    }

    // Função para salvar os dados no localStorage
    function salvarDados() {
        // Obter valores dos campos a serem salvos
        const nome = document.getElementById('nome').value;
        const matricula = document.getElementById('matricula').value;
        const semestre = document.getElementById('semestre').value;
        const professor = document.getElementById('professor').value;
        const modelo = document.getElementById('modelo').value;

        // Salvar os campos solicitados
        localStorage.setItem('diarioCampo_nome', nome);
        localStorage.setItem('diarioCampo_matricula', matricula);
        localStorage.setItem('diarioCampo_semestre', semestre);
        localStorage.setItem('diarioCampo_professor', professor);
        localStorage.setItem('diarioCampo_modelo', modelo);
    }

    // Função para carregar os dados do localStorage
    function carregarDados() {
        // Carregar valores dos campos salvos
        const nome = localStorage.getItem('diarioCampo_nome');
        const matricula = localStorage.getItem('diarioCampo_matricula');
        const semestre = localStorage.getItem('diarioCampo_semestre');
        const professor = localStorage.getItem('diarioCampo_professor');
        const modelo = localStorage.getItem('diarioCampo_modelo');

        // Preencher os campos se os dados existirem
        if (nome) document.getElementById('nome').value = nome;
        if (matricula) document.getElementById('matricula').value = matricula;
        if (semestre) document.getElementById('semestre').value = semestre;
        if (professor) document.getElementById('professor').value = professor;
        if (modelo) document.getElementById('modelo').value = modelo;
        
        // Aplicar o modelo carregado
        if (modelo) {
            mostrarCamposModelo(modelo);
        }
    }

    // Limpar localStorage (exceto dados pessoais e preferências)
    function limparLocalStorageExcetoDadosPessoais() {
        // Obter valores antes de limpar
        const nome = localStorage.getItem('diarioCampo_nome');
        const matricula = localStorage.getItem('diarioCampo_matricula');
        const semestre = localStorage.getItem('diarioCampo_semestre');
        const professor = localStorage.getItem('diarioCampo_professor');
        const modelo = localStorage.getItem('diarioCampo_modelo');
        
        // Remover todos os itens com prefixo diarioCampo_
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('diarioCampo_')) {
                localStorage.removeItem(key);
            }
        });
        
        // Restaurar apenas os campos que queremos manter
        if (nome) localStorage.setItem('diarioCampo_nome', nome);
        if (matricula) localStorage.setItem('diarioCampo_matricula', matricula);
        if (semestre) localStorage.setItem('diarioCampo_semestre', semestre);
        if (professor) localStorage.setItem('diarioCampo_professor', professor);
        if (modelo) localStorage.setItem('diarioCampo_modelo', modelo);
    }

    // Limpar completamente o localStorage
    function limparTodosOsDados() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('diarioCampo_')) {
                localStorage.removeItem(key);
            }
        });
        
        // Recarregar a página para limpar os campos
        location.reload();
    }

    // Lidar com a seleção do modelo
    document.getElementById('modelo').addEventListener('change', function() {
      const secaoBibliografia = document.getElementById('secaoBibliografia');
      if (this.value === 'ABNT NR-37') {
        secaoBibliografia.classList.remove('hidden');
      } else {
        secaoBibliografia.classList.add('hidden');
      }
    });

    // Adicionar nova fonte bibliográfica
    document.getElementById('adicionarFonte').addEventListener('click', function() {
      const fontesContainer = document.getElementById('fontesContainer');
      const novaFonte = document.createElement('div');
      novaFonte.className = 'fonte-item';
      novaFonte.innerHTML = `
        <div class="d-flex mb-2">
          <textarea class="form-control fonte-texto" placeholder="Insira a referência bibliográfica no formato ABNT"></textarea>
          <div class="ms-2 d-flex flex-column">
            <button type="button" class="btn btn-sm btn-outline-danger mb-1 remover-fonte"><i class="fas fa-times"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary mb-1 mover-cima" title="Mover para cima"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary mover-baixo" title="Mover para baixo"><i class="fas fa-arrow-down"></i></button>
          </div>
        </div>
      `;
      fontesContainer.appendChild(novaFonte);
      configurarBotoesFonte();
    });

    // Configurar botões de cada fonte
    function configurarBotoesFonte() {
      // Botões para remover fontes
      document.querySelectorAll('.remover-fonte').forEach(botao => {
        botao.onclick = function() {
          this.closest('.fonte-item').remove();
        };
      });

      // Botões para mover a fonte para cima
      document.querySelectorAll('.mover-cima').forEach(botao => {
        botao.onclick = function() {
          const fonteItem = this.closest('.fonte-item');
          const anterior = fonteItem.previousElementSibling;
          if (anterior) {
            fonteItem.parentNode.insertBefore(fonteItem, anterior);
          }
        };
      });

      // Botões para mover a fonte para baixo
      document.querySelectorAll('.mover-baixo').forEach(botao => {
        botao.onclick = function() {
          const fonteItem = this.closest('.fonte-item');
          const proximo = fonteItem.nextElementSibling;
          if (proximo) {
            fonteItem.parentNode.insertBefore(proximo, fonteItem);
          }
        };
      });
    }

    // Ordenar fontes alfabeticamente
    document.getElementById('ordenarFontes').addEventListener('click', function() {
      const fontesContainer = document.getElementById('fontesContainer');
      const fontesItems = Array.from(fontesContainer.querySelectorAll('.fonte-item'));
      
      // Coletar o texto e elemento de cada fonte
      const fontes = fontesItems.map(item => {
        return {
          elemento: item,
          texto: item.querySelector('.fonte-texto').value.trim()
        };
      });
      
      // Ordenar alfabeticamente ignorando caracteres especiais iniciais como [ ] ou números
      fontes.sort((a, b) => {
        const textoA = a.texto.replace(/^\[[0-9]+\]\s*/, '').replace(/^[^a-zA-Z0-9]+/, '');
        const textoB = b.texto.replace(/^\[[0-9]+\]\s*/, '').replace(/^[^a-zA-Z0-9]+/, '');
        return textoA.localeCompare(textoB, 'pt-BR');
      });
      
      // Remover todos os itens atuais
      fontesItems.forEach(item => item.remove());
      
      // Adicionar de volta na nova ordem
      fontes.forEach(fonte => {
        fontesContainer.appendChild(fonte.elemento);
      });
    });

    // Inicializar configuração dos botões de fonte
    configurarBotoesFonte();
    
    // Configurar campos do formulário para salvar automaticamente
    document.querySelectorAll('input, select, textarea').forEach(el => {
        // Salvar campos específicos
        if (el.id === 'nome' || el.id === 'matricula' || el.id === 'semestre' || 
            el.id === 'professor' || el.id === 'modelo') {
            el.addEventListener('change', salvarDados);
            el.addEventListener('input', salvarDados);
        }
    });

    // Inicializar após carregar o documento
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar o TinyMCE
        initTinyMCE();
        
        // Inicializar seleção de imagens
        inicializarSelecaoImagens();
        
        // Carregar dados salvos do localStorage
        carregarDados();
        
        // Definir a data atual se não estiver preenchida
        if (!document.getElementById('data').value) {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            document.getElementById('data').value = `${ano}-${mes}-${dia}`;
        }
        
        // Configurar evento de mudança no campo de modelo
        document.getElementById('modelo').addEventListener('change', function() {
            mostrarCamposModelo(this.value);
            salvarDados(); // Salvar quando o modelo mudar
        });
        
        // Configurar evento de submissão do formulário
        document.getElementById('diarioForm').addEventListener('submit', function(event) {
            event.preventDefault();
            gerarPDF();
        });
        
        // Aplicar o modelo selecionado inicialmente
        mostrarCamposModelo(document.getElementById('modelo').value);
        
        // Inicializar o tema baseado na preferência do usuário
        initTheme();
        
        // Inicializar contador de palavras para o TinyMCE
        initWordCounter();
    });
    
    // Função para limpar formulário
    function limparFormulario() {
        if (confirm('Tem certeza que deseja limpar todos os campos? Esta ação não pode ser desfeita.')) {
            document.getElementById('diarioForm').reset();
            
            // Limpar o editor TinyMCE
            tinymce.get('relatorio').setContent('');
            
            // Limpar a lista de imagens
            limparImagens();
            
            // Limpar os campos ABNT se existirem
            const campos = ['objetivo', 'justificativa', 'contextualizacao', 'metodologia', 'conclusao'];
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) elemento.value = '';
            });
            
            // Limpar as fontes bibliográficas
            document.querySelectorAll('.fonte-texto').forEach(textarea => {
                textarea.value = '';
            });
            
            // Remover todas as fontes exceto a primeira
            const fontesContainer = document.getElementById('fontesContainer');
            if (fontesContainer) {
                const fontes = fontesContainer.querySelectorAll('.fonte-item');
                for (let i = 1; i < fontes.length; i++) {
                    fontesContainer.removeChild(fontes[i]);
                }
            }
            
            // Manter apenas nome e matrícula no localStorage
            limparLocalStorageExcetoDadosPessoais();
            
            // Redefinir a data para hoje
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            document.getElementById('data').value = `${ano}-${mes}-${dia}`;
            
            alert('Formulário limpo com sucesso!');
        }
    }

    // Função para inicializar o TinyMCE
    function initTinyMCE() {
        tinymce.init({
            selector: '#relatorio',
            plugins: 'autolink link image lists table wordcount',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | table',
            height: 400,
            setup: function(editor) {
                // Atualizar o contador de palavras
                editor.on('KeyUp', function(e) {
                    updateWordCount();
                });
                editor.on('Change', function(e) {
                    updateWordCount();
                });
            }
        });
        
        // Adicionar contador de palavras
        const contadorContainer = document.createElement('div');
        contadorContainer.innerHTML = '<div id="wordCount" class="mt-2 text-muted">0 palavras</div>';
        document.querySelector('.tox-tinymce').after(contadorContainer);
    }
    
    // Remover antiga função de carregamento de dados
    // Substitua pelo novo carregarDados() já definido acima
    
    // Configurar campos do formulário para salvar automaticamente
    document.querySelectorAll('input, select, textarea').forEach(el => {
        // Salvar apenas nome e matrícula
        if (el.id === 'nome' || el.id === 'matricula') {
            el.addEventListener('change', salvarDados);
            el.addEventListener('input', salvarDados);
        }
    });
  </script>
  
  <footer id="footer">
    <p>Última atualização: <span id="last-update">carregando...</span></p>
  </footer>

  <!-- Scripts do pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <!-- Configurar fontes disponíveis no pdfMake -->
  <script>
      // Verificar quais fontes estão disponíveis no pdfMake
      document.addEventListener('DOMContentLoaded', function() {
          if (typeof pdfMake !== 'undefined') {
              console.log("Fontes disponíveis no pdfMake:", Object.keys(pdfMake.vfs));
          }
      });
  </script>
</body>
</html>
