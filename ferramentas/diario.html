<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diário de Campo - Medicina</title>
  <meta property="og:title" content="Diário de Campo - IESC">
  <meta property="og:description" content="A ferramenta pra quem precisa criar um Diário de Campo, de forma rápida e já modelada.">
  <meta property="og:image" content="https://i.ibb.co/RG93kY6V/Inserir-um-pouquinho-de-texto-3.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://thiago.med.br">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Bootstrap CSS -->
  <script src="https://cdn.tiny.cloud/1/wnknc1eopnaayokad1axrsn0koq4pgrndxu8rhd7ozx5j9sg/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blob-polyfill@7.0.20220408/Blob.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #0ea5e9;
      --accent: #8b5cf6;
      --success: #10b981;
      --background-light: #f8fafc;
      --background-dark: #0f172a;
      --text-light: #1e293b;
      --text-dark: #f1f5f9;
      --border-light: #e2e8f0;
      --border-dark: #334155;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Tema Claro */
    body.light {
      background: linear-gradient(-45deg, #f0f9ff, #e0f2fe, #dbeafe, #ede9fe);
      color: var(--text-light);
    }

    /* Tema Escuro */
    body.dark {
      background: linear-gradient(-45deg, #020617, #1e1b4b, #1e1b4b, #020617);
      color: var(--text-dark);
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 40px;
      border-radius: 24px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .container::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 24px;
      padding: 2px;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      z-index: -1;
    }

    .container.light {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .container.dark {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    #home h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    #home p {
      color: var(--text-light);
      font-size: 1.1rem;
      line-height: 1.6;
      opacity: 0.9;
    }

    .dark #home p {
      color: var(--text-dark);
    }

    #home button {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border: none;
      padding: 16px 32px;
      font-size: 1.1rem;
      border-radius: 16px;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    #home button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        120deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: 0.5s;
    }

    #home button:hover::before {
      left: 100%;
    }

    #home button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      color: inherit;
      opacity: 0.9;
    }

    input, select {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 16px;
      border: 2px solid var(--border-light);
      border-radius: 14px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: transparent;
      color: inherit;
      cursor: pointer;
    }

    /* Estilização das opções do select */
    select option {
      background-color: var(--background-light);
      color: var(--text-light);
      padding: 12px;
    }

    .dark select option {
      background-color: var(--background-dark);
      color: var(--text-dark);
    }

    /* Estilização do select quando aberto */
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    .dark select:focus {
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
    }

    /* Cor do placeholder do select */
    select option[value=""] {
      color: rgba(0, 0, 0, 0.5);
    }

    .dark select option[value=""] {
      color: rgba(255, 255, 255, 0.5);
    }

    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #theme-toggle:hover {
      transform: rotate(45deg);
    }

    #changelogButton {
      position: fixed;
      top: 20px;
      right: 80px;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: inherit;
    }

    #changelogButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn {
      border-radius: 14px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border: none;
      color: white;
    }

    .btn-info {
      background: linear-gradient(45deg, var(--secondary), var(--accent));
      border: none;
      color: white;
    }

    .modal-content {
      border-radius: 24px;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
    }

    .dark .modal-content {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-dark);
    }

    .modal-header {
      border-bottom: 1px solid rgba(229, 231, 235, 0.1);
      padding: 24px;
    }

    .modal-body {
      padding: 32px;
    }

    .feedback-btn {
      padding: 16px 28px;
      border-radius: 14px;
      font-size: 1.2rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: transparent;
      border: 2px solid var(--border-light);
    }

    .dark .feedback-btn {
      border-color: var(--border-dark);
    }

    .feedback-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .feedback-btn.active {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 16px;
      text-align: center;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.1);
    }

    .dark footer {
      background: rgba(15, 23, 42, 0.5);
    }

    /* Back button styles */
    #backButton {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 8px 20px;
      border-radius: 30px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }

    #backButton:hover {
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 24px;
      }

      #home h1 {
        font-size: 2.2rem;
      }

      #home button {
        font-size: 1rem;
        padding: 14px 24px;
      }

      #theme-toggle {
        top: 12px;
        right: 12px;
      }

      #changelogButton {
        top: 12px;
        right: 70px;
        font-size: 0.8rem;
        padding: 8px 16px;
      }
    }

    .hidden {
      display: none !important;
    }

    /* Animações */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      animation: fadeIn 0.5s ease-out;
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: var(--secondary);
    }

    /* Preview styles */
    #preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
      margin-top: 16px;
      width: 100%;
    }

    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: var(--background-light);
    }

    .dark .preview-item {
      background: var(--background-dark);
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s ease;
      z-index: 2;
    }

    .remove-btn:hover {
      background: rgb(220, 38, 38);
      transform: scale(1.1);
    }

    /* TinyMCE customization */
    .tox-tinymce {
      border-radius: 14px !important;
      overflow: hidden;
      border: 2px solid var(--border-light) !important;
    }

    .dark .tox-tinymce {
      border-color: var(--border-dark) !important;
    }

    .dark .tox-edit-area__iframe {
      background: var(--background-dark) !important;
    }

    .dark .tox-toolbar,
    .dark .tox-statusbar {
      background: var(--background-dark) !important;
    }

    /* Modal footer fix */
    .modal-footer {
      border-top: 1px solid rgba(229, 231, 235, 0.1);
      padding: 20px;
    }

    .pdf-list {
      margin-top: 20px;
      border: 2px dashed var(--border-light);
      border-radius: 14px;
      padding: 20px;
      min-height: 200px;
    }

    .dark .pdf-list {
      border-color: var(--border-dark);
    }

    .pdf-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      border: 1px solid var(--border-light);
    }

    .dark .pdf-item {
      border-color: var(--border-dark);
    }

    .pdf-item .pdf-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pdf-item .pdf-icon {
      font-size: 24px;
      color: var(--primary);
    }

    .pdf-item .pdf-name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .pdf-item .pdf-date {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .pdf-item .remove-pdf {
      background: none;
      border: none;
      color: var(--emergency-red);
      cursor: pointer;
      font-size: 18px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .pdf-item .remove-pdf:hover {
      opacity: 1;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 1rem;
    }
    
    .btn-group .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      font-weight: 500;
    }
    
    .btn-group .btn i {
      font-size: 1.1em;
    }
  </style>
</head>
<body class="light">
  <!-- Botão de Voltar -->
  <button id="backButton" onclick="handleBack()">← Voltar</button>
  
  <!-- Botão de Troca de Tema -->
  <button id="theme-toggle">🌙</button>
  <!-- Botão de Changelogs na página inicial -->
  <button id="changelogButton" class="btn btn-sm btn-outline-secondary" style="position: absolute; top: 20px; right: 60px;" data-bs-toggle="modal" data-bs-target="#changelogModal">Changelogs</button>

  <!-- Página Inicial -->
  <div id="home" class="container light">
    <h1>Diário de Campo (Logbook)</h1>
    <p class="text-center mb-4">Crie seu relatório de vivências para o IESC!</p>
    <button class="btn btn-lg w-100 mb-3" onclick="showCreatePage()">Criar Diário de Campo</button>
    <button class="btn btn-lg w-100" onclick="showAttachPage()">Anexar Diários</button>
    <p class="text-center mt-4" style="font-size: 0.9rem;">Criado por Thiago F. Rodrigues</p>
  </div>

  <!-- Página de Anexar PDFs -->
  <div id="attach" class="container light hidden">
    <h1>Anexar Diários</h1>
    <div class="mb-4">
      <input type="file" id="pdfInput" multiple accept=".pdf" class="form-control mb-3" onchange="handlePDFUpload(event)">
      <div id="pdfPreview" class="pdf-list"></div>
    </div>
    <button class="btn btn-success" onclick="mergePDFs()">Combinar PDFs</button>
    <button class="btn btn-secondary ms-2" onclick="showHomePage()">Voltar</button>
  </div>

  <!-- Página de Criação do Diário -->
  <div id="create" class="container light hidden">
    <h1>Criar Diário de Campo</h1>
    <!-- Botão para abrir as instruções de criação do diário -->
    <button type="button" class="btn btn-info mb-3" data-bs-toggle="modal" data-bs-target="#instructionsModal">Instruções para Diário</button>
    <form id="diarioForm">
      <label for="nome">Nome do Aluno:</label>
      <input type="text" id="nome" required>

      <label for="matricula">Matrícula:</label>
      <input type="number" id="matricula" required>

      <label for="data">Data (DD/MM/AAAA):</label>
      <input type="date" id="data" required>

      <label for="local">Local de Prática:</label>
      <input type="text" id="local" required>

      <label for="professor">Professor(a):</label>
      <select id="professor" required>
        <option value="">Selecione Professor(a)</option>
        <option value="RONALD TEIXEIRA PEÇANHA FERNANDES">RONALD TEIXEIRA PEÇANHA FERNANDES</option>
        <option value="DANIELLE CECATO DE ALMEIDA PASSOS">DANIELLE CECATO DE ALMEIDA PASSOS</option>
      </select>

      <label for="relatorio">Relatório de Campo:</label>
      <textarea id="relatorio" name="relatorio" required></textarea>
      <small class="text-muted d-block mt-1 mb-3">Dica: Para melhor formatação, use parágrafos curtos e evite espaçamentos excessivos. Você pode colar texto de outras fontes diretamente.</small>

      <label for="fotos">Anexar Fotos (máx. 6, atualmente <span id="imageCount">0</span>/6):</label>
      <input type="file" id="fotos" multiple accept="image/*" onchange="handleImageUpload(event)">
      <div id="preview"></div>

      <button type="button" class="btn btn-success mt-3" onclick="gerarPDF()">Finalizar</button>
    </form>
  </div>

  <!-- Modal de Instruções para Diário -->
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="instructionsModalLabel">Instruções para criação de Diário</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <ul>
            <li>Este diário deve ser submetido através da plataforma CANVAS.</li>
            <li>A data do relato deve corresponder ao dia em que a atividade foi realizada, e não ao dia em que o relatório está sendo elaborado.</li>
            <li>No relato, o aluno deve redigir um texto detalhado sobre as experiências vivenciadas no respectivo dia no IESC.</li>
            <li>É necessário incluir considerações finais, objetivos alcançados durante a aula e os aprendizados significativos do dia.</li>
            <li>Fotografias podem ser anexadas, caso sejam relevantes e pertinentes à atividade realizada no dia do relato.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Changelogs -->
	<div class="modal fade" id="changelogModal" tabindex="-1" aria-labelledby="changelogModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="changelogModalLabel">Changelogs</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
		  </div>
		  <div class="modal-body">
			<div id="changelogContent">
			  <!-- Conteúdo do changelog estático -->
			  <h5>Atualizações (04/03/2025)</h5>
			  <ul>
				<li>Melhorias na visibilidade das opções do select em modo escuro.</li>
				<li>Melhorando o design do diário de campo.</li>
				<li>Atualização das instruções para criação do diário, tornando-as mais instrutivas e formais.</li>
			  </ul>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
		  </div>
		</div>
	  </div>
	</div>
		
		<!-- Modal de Feedback -->
	<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="feedbackModalLabel">Avalie sua experiência</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
		  </div>
		  <div class="modal-body">
			<form id="feedbackForm">
			  <div class="d-flex justify-content-between mb-3">
				<button type="button" class="btn feedback-btn" data-rating="Ruim">❌</button>
				<button type="button" class="btn feedback-btn" data-rating="Normal">➖</button>
				<button type="button" class="btn feedback-btn" data-rating="Bom">✅</button>
				<button type="button" class="btn feedback-btn" data-rating="Excelente">💯</button>
			  </div>
			  
			  <div class="mb-3">
				<label for="comentario" class="form-label">O que pode melhorar na ferramenta? (opcional)</label>
				<textarea class="form-control" id="comentario" rows="2"></textarea>
			  </div>
			  
			  <div class="text-center">
				<button type="submit" class="btn btn-primary btn-sm">Enviar</button>
			  </div>
			</form>
		  </div>
		  <div class="modal-footer justify-content-center">
			<small>Criado por Thiago F. Rodrigues</small>
		  </div>
		</div>
	  </div>
	</div>


  <!-- Bibliotecas Externas -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blueimp-load-image@5.16.0/js/load-image.all.min.js"></script>

  <script>
    let selectedImages = [];
    let selectedPDFs = [];

    // Inicialização do TinyMCE
    tinymce.init({
      selector: '#relatorio',
      height: 300,
      menubar: false,
      plugins: 'lists paste autolink',
      toolbar: 'undo redo | bold italic underline | bullist numlist | alignleft aligncenter alignright alignjustify',
      paste_as_text: false,
      paste_enable_default_filters: true,
      paste_word_valid_elements: 'b,strong,i,em,h1,h2,h3,p,br',
      paste_retain_style_properties: 'none',
      paste_text_linebreaktype: 'p',
      paste_remove_styles: true,
      paste_remove_styles_if_webkit: true,
      paste_strip_class_attributes: 'all',
      browser_spellcheck: true,
      contextmenu: false,
      entity_encoding: 'raw',
      forced_root_block: 'p',
      init_instance_callback: function(editor) {
        // Remove the required attribute from the hidden textarea
        const textarea = document.getElementById('relatorio');
        textarea.removeAttribute('required');
        
        // Prevent form submission
        document.getElementById('diarioForm').addEventListener('submit', function(e) {
          e.preventDefault(); // Prevent form submission
          if (!editor.getContent().trim()) {
            alert('Por favor, preencha o relatório.');
          }
        });
      },
      setup: function(editor) {
        editor.on('init', function() {
          if (document.body.classList.contains('dark')) {
            editor.getContainer().style.backgroundColor = '#444';
            editor.getContainer().style.color = '#e9ecef';
            // Set the content area background and text color
            editor.getBody().style.backgroundColor = '#1e1e1e';
            editor.getBody().style.color = '#e9ecef';
          }
        });
        
        // Formatar texto colado automaticamente
        editor.on('paste', function(e) {
          setTimeout(function() {
            const content = editor.getContent();
            const formattedContent = content
              .replace(/<p>\s*<\/p>/g, '') // Remove parágrafos vazios
              .replace(/\n\s*\n/g, '\n') // Remove linhas em branco extras
              .replace(/(<br\s*\/?>){3,}/gi, '<br /><br />'); // Limita quebras de linha consecutivas
            editor.setContent(formattedContent);
          }, 100);
        });
        
        // Adicionar atalho para colar como texto simples
        editor.addShortcut('ctrl+shift+v', 'Colar como texto', function() {
          editor.execCommand('mceTogglePlainTextPaste');
        });
      },
      content_style: `
        body { font-family: 'Plus Jakarta Sans', sans-serif; line-height: 1.6; }
        body.dark { background-color: #1e1e1e; color: #e9ecef; }
        p { margin: 0 0 0.75em 0; line-height: 1.5; }
        ul, ol { margin-bottom: 0.75em; }
        li { margin-bottom: 0.25em; }
      `
    });

    // Remover o evento de carregamento do logo
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.add('hidden');
      toggleTheme(); // Configura o tema inicial
    });

    function showHomePage() {
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.add('hidden');
      document.getElementById('footer').style.display = 'block';
    }

    function showCreatePage() {
      document.getElementById('home').classList.add('hidden');
      document.getElementById('create').classList.remove('hidden');
      document.getElementById('attach').classList.add('hidden');
      document.getElementById('footer').style.display = 'none';
    }

    function showAttachPage() {
      document.getElementById('home').classList.add('hidden');
      document.getElementById('create').classList.add('hidden');
      document.getElementById('attach').classList.remove('hidden');
      document.getElementById('footer').style.display = 'none';
    }

    function handleImageUpload(event) {
      const files = Array.from(event.target.files);
      if (selectedImages.length + files.length > 6) {
        alert("Você pode selecionar no máximo 6 imagens.");
        event.target.value = ''; // Limpa a seleção
        return;
      }
      selectedImages = [...selectedImages, ...files];
      renderPreview();
    }
	
		async function loadImageAsync(file) {
		  return new Promise((resolve, reject) => {
			loadImage(
			  file,
			  (imgOrCanvas) => {
				const img = document.createElement('img');
				img.src = imgOrCanvas.toDataURL(file.type);
				resolve(img);
			  },
			  {
				orientation: true,
				canvas: true,
				meta: true
			  }
			);
		  });
		}
		
		function createPreviewItem(img, index) {
		  const item = document.createElement('div');
		  item.className = 'preview-item';
		  
		  img.style.maxWidth = '100%';
		  img.style.height = 'auto';
		  item.appendChild(img);

		  const removeBtn = document.createElement('button');
		  removeBtn.className = 'remove-btn';
		  removeBtn.textContent = 'X';
		  removeBtn.onclick = () => removeImage(index);
		  item.appendChild(removeBtn);

		  return item;
		}
		
		async function processImageForPDF(file) {
		  return new Promise((resolve, reject) => {
			loadImage(
			  file,
			  (canvas) => {
				try {
				  // Redimensionar a imagem para um tamanho razoável
				  const maxWidth = 800;
				  const maxHeight = 600;
				  let width = canvas.width;
				  let height = canvas.height;
				  
				  if (width > maxWidth) {
					height = (maxWidth / width) * height;
					width = maxWidth;
				  }
				  
				  if (height > maxHeight) {
					width = (maxHeight / height) * width;
					height = maxHeight;
				  }
				  
				  // Criar um novo canvas com as dimensões ajustadas
				  const resizedCanvas = document.createElement('canvas');
				  resizedCanvas.width = width;
				  resizedCanvas.height = height;
				  const ctx = resizedCanvas.getContext('2d');
				  ctx.drawImage(canvas, 0, 0, width, height);
				  
				  // Converter para dataURL
				  const dataURL = resizedCanvas.toDataURL('image/jpeg', 0.8);
				  resolve({ dataURL });
				} catch (error) {
				  reject(error);
				}
			  },
			  {
				orientation: true,
				canvas: true,
				meta: true
			  }
			);
		  });
		}

	async function renderPreview() {
	  const preview = document.getElementById('preview');
	  preview.innerHTML = '';
	  
	  for (const [index, file] of selectedImages.entries()) {
		try {
		  const img = await loadImageAsync(file);
		  const item = createPreviewItem(img, index);
		  preview.appendChild(item);
		} catch (error) {
		  console.error('Error ao carregar a imagem:', error);
		}
	  }
	  updateImageCount();
	}

    function removeImage(index) {
      selectedImages.splice(index, 1);
      renderPreview();
    }

    function updateImageCount() {
      document.getElementById('imageCount').textContent = selectedImages.length;
    }

    // Função para alternar tema
	function toggleTheme() {
	  const body = document.body;
	  const containers = document.querySelectorAll('.container');
	  const toggleButton = document.getElementById('theme-toggle');
	  const modals = document.querySelectorAll('.modal-content');

	  if (body.classList.contains('light')) {
		// Tema Escuro
		body.classList.replace('light', 'dark');
		containers.forEach(container => container.classList.replace('light', 'dark'));
		modals.forEach(modal => {
		  modal.classList.replace('light', 'dark');
		  modal.style.backgroundColor = '#2c3e50';
		  modal.style.color = '#e9ecef';
		});
		toggleButton.textContent = '☀️';
		
		// Ajustar TinyMCE
		if (tinymce.activeEditor) {
		  tinymce.activeEditor.getContainer().style.backgroundColor = '#444';
		  tinymce.activeEditor.getContainer().style.color = '#e9ecef';
		  tinymce.activeEditor.getBody().style.backgroundColor = '#1e1e1e';
		  tinymce.activeEditor.getBody().style.color = '#e9ecef';
		}
	  } else {
		// Tema Claro
		body.classList.replace('dark', 'light');
		containers.forEach(container => container.classList.replace('dark', 'light'));
		modals.forEach(modal => {
		  modal.classList.replace('dark', 'light');
		  modal.style.backgroundColor = '#fff';
		  modal.style.color = '#2c3e50';
		});
		toggleButton.textContent = '🌙';
		
		// Ajustar TinyMCE
		if (tinymce.activeEditor) {
		  tinymce.activeEditor.getContainer().style.backgroundColor = '#fff';
		  tinymce.activeEditor.getContainer().style.color = '#2c3e50';
		  tinymce.activeEditor.getBody().style.backgroundColor = '#fff';
		  tinymce.activeEditor.getBody().style.color = '#2c3e50';
		}
	  }
	}

    // Evento do botão de tema
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    async function gerarPDF() {
      // Verificar se a biblioteca pdfmake está carregada
      if (typeof pdfMake === 'undefined') {
        alert("Erro: A biblioteca pdfMake não foi carregada corretamente. Verifique sua conexão com a internet e recarregue a página.");
        return;
      }

      // Capturar os valores dos campos
      const nome = document.getElementById('nome').value.trim();
      const matricula = document.getElementById('matricula').value.trim();
      const data = document.getElementById('data').value;
      const local = document.getElementById('local').value.trim();
      const professor = document.getElementById('professor').value;
      const relatorio = tinymce.get('relatorio').getContent({ format: 'text' });

	// Ajustar o título do professor
      const professorFormatado = professor.trim().toLowerCase() === "danielle cecato de almeida passes".toLowerCase() ? "Professora" : "Professor";

      // Formatar data para DD/MM/AAAA
      const [ano, mes, dia] = data.split('-');
      const dataFormatada = `${dia}/${mes}/${ano}`;

      // Formatar o texto do relatório
      const relatorioFormatado = relatorio
        .replace(/\n{3,}/g, '\n\n')
        .replace(/\t/g, '    ')
        .trim();

      // Processar imagens para o PDF
      const imagensProcessadas = [];
      if (selectedImages.length > 0) {
        try {
          for (let file of selectedImages.slice(0, 6)) {
            const processed = await processImageForPDF(file);
            imagensProcessadas.push({
              image: processed.dataURL,
              width: 80,
              height: 80
            });
          }
      } catch (e) {
          alert("Erro ao processar as imagens. Certifique-se de que são válidas.");
          console.error(e);
          return;
        }
      }

      // Definir estrutura do documento
      const docDefinition = {
        pageSize: 'A4',
        pageMargins: [40, 40, 40, 40],
        defaultStyle: {
          fontSize: 12
        },
        content: [
          // Página 1
          {
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'A seguir uma apresentação do relato de vivências.',
                style: 'subheader',
                alignment: 'center',
                margin: [0, 0, 0, 20]
              },
              {
                text: `Data: ${dataFormatada}`,
                style: 'small',
                margin: [0, 0, 0, 10]
              },
              {
                text: '1. Informações institucionais;',
                style: 'small',
                margin: [0, 0, 0, 5]
              },
              {
                text: '2. Identificação e detalhes.',
                style: 'small',
                margin: [0, 0, 0, 10]
              },
              {
                canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 1 }],
                margin: [0, 0, 0, 20]
              },
              {
                text: 'INSTITUIÇÃO',
                style: 'sectionHeader',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'Universidade Unigranrio - Afya - Campus Barra da Tijuca',
                style: 'small',
                margin: [0, 0, 0, 5]
              },
              {
                text: 'Av. Ayrton Senna, 2.200 – Barra da Tijuca, Rio de Janeiro - RJ, 22775-003',
                style: 'small',
                margin: [0, 0, 0, 20]
              },
              {
                text: 'IDENTIFICAÇÃO & DETALHES',
                style: 'sectionHeader',
                margin: [0, 0, 0, 10]
              },
              {
                ul: [
        `Nome: ${nome}`,
        `Matrícula: ${matricula}`,
                  'Curso: Medicina',
                  'Turno: Integral',
                  'Semestre: 1° Semestre de 2025',
                  'Disciplina: IESC (Integração Ensino-Serviço-Comunidade)',
        `Local de Prática: ${local}`,
        `${professorFormatado}: ${professor}`
                ],
                style: 'list',
                margin: [0, 0, 0, 20]
              },
              {
                text: 'Página 01 (um)',
                style: 'footer',
                alignment: 'center',
                margin: [0, 20, 0, 0]
              }
            ],
            pageBreak: 'after'
          },
          
          // Página 2 (relatório)
          {
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                text: `Data: ${dataFormatada}`,
                style: 'small',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'TEXTO RELATORIAL',
                style: 'sectionHeader',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                canvas: [
                  {
                    type: 'rect',
                    x: 0,
                    y: 0,
                    w: 515,
                    h: 600,
                    lineWidth: 1,
                    lineColor: '#000000'
                  }
                ],
                margin: [0, 0, 0, 20]
              },
              {
                text: relatorioFormatado,
                style: 'paragraph',
                margin: [10, -580, 10, 0]
              },
              {
                text: 'Página 02 (dois)',
                style: 'footer',
                alignment: 'center',
                margin: [0, 20, 0, 0]
              }
            ],
            pageBreak: imagensProcessadas.length > 0 ? 'after' : undefined
          }
        ],
        styles: {
          header: {
            fontSize: 22,
            bold: true,
            margin: [0, 0, 0, 10]
          },
          subheader: {
            fontSize: 12,
            margin: [0, 0, 0, 5]
          },
          sectionHeader: {
            fontSize: 14,
            bold: true,
            margin: [0, 0, 0, 10]
          },
          paragraph: {
            fontSize: 12,
            lineHeight: 1.5,
            alignment: 'justify'
          },
          small: {
            fontSize: 10
          },
          list: {
            fontSize: 12,
            lineHeight: 1.3
          },
          footer: {
            fontSize: 10,
            margin: [0, 20, 0, 0]
          }
        }
      };

      // Se houver imagens, adicionar uma terceira página
      if (imagensProcessadas.length > 0) {
        // Criar tabela para as imagens (até 3 por linha)
        const rows = [];
        let currentRow = [];
        
        for (let i = 0; i < imagensProcessadas.length; i++) {
          currentRow.push(imagensProcessadas[i]);
          
          if (currentRow.length === 3 || i === imagensProcessadas.length - 1) {
            while (currentRow.length < 3) {
              currentRow.push({});
            }
            rows.push(currentRow);
            currentRow = [];
          }
        }
        
        docDefinition.content.push(
          {
            stack: [
              {
                text: 'DIÁRIO DE CAMPO',
                style: 'header',
                alignment: 'center',
                margin: [0, 0, 0, 10]
              },
              {
                text: `Data: ${dataFormatada}`,
                style: 'small',
                margin: [0, 0, 0, 10]
              },
              {
                text: 'FOTOGRAFIAS DA ATIVIDADE',
                style: 'sectionHeader',
                alignment: 'center',
                margin: [0, 0, 0, 20]
              },
              {
                table: {
                  widths: ['*', '*', '*'],
                  body: rows
                },
                layout: 'noBorders',
                margin: [0, 0, 0, 20]
              },
              {
                text: 'Página 03 (três)',
                style: 'footer',
                alignment: 'center',
                margin: [0, 20, 0, 0]
              }
            ]
          }
        );
      }

      // Gerar o PDF
      const dataFormatada2 = `${dia}-${mes}-${ano}`; // Usa '-' ao invés de '/'
      const fileName = `Diário de Campo - ${dataFormatada2}.pdf`;
      
      try {
        // Criar um indicador de carregamento
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'alert alert-info mt-3';
        loadingIndicator.textContent = 'Gerando PDF... Por favor, aguarde.';
        document.getElementById('diarioForm').appendChild(loadingIndicator);
        
        // Gerar o PDF
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        
        // Criar container para os botões
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'btn-group mt-3 d-flex gap-2';
        document.getElementById('diarioForm').appendChild(buttonContainer);
        
        // Botão para visualizar o PDF
        const viewButton = document.createElement('button');
        viewButton.className = 'btn btn-primary';
        viewButton.innerHTML = '<i class="fas fa-eye"></i> Visualizar PDF';
        viewButton.onclick = function() {
          pdfDocGenerator.open({}, window);
        };
        buttonContainer.appendChild(viewButton);
        
        // Botão para download direto
        const downloadButton = document.createElement('button');
        downloadButton.className = 'btn btn-success';
        downloadButton.innerHTML = '<i class="fas fa-download"></i> Baixar PDF';
        downloadButton.onclick = function() {
          try {
            pdfDocGenerator.download(fileName);
          } catch (downloadError) {
            console.error('Erro ao fazer download:', downloadError);
            alert('Não foi possível fazer o download automático. O PDF será aberto em uma nova janela, você pode salvá-lo de lá.');
            pdfDocGenerator.open({}, window);
          }
        };
        buttonContainer.appendChild(downloadButton);
        
        // Remover o indicador de carregamento após um tempo
        setTimeout(() => {
          if (document.contains(loadingIndicator)) {
            loadingIndicator.remove();
          }
          // Adicionar mensagem de sucesso
          const successMessage = document.createElement('div');
          successMessage.className = 'alert alert-success mt-3';
          successMessage.textContent = 'PDF gerado com sucesso! Você pode visualizá-lo ou baixá-lo usando os botões acima.';
          document.getElementById('diarioForm').appendChild(successMessage);
          
          // Remover mensagem de sucesso após 5 segundos
          setTimeout(() => {
            if (document.contains(successMessage)) {
              successMessage.remove();
            }
          }, 5000);
          
          // Mostrar feedback
		showFeedbackWithDelay();
        }, 2000);
        
      } catch (error) {
        console.error('Erro ao gerar o PDF:', error);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert alert-danger mt-3';
        errorMessage.innerHTML = `
          <strong>Erro ao gerar o PDF</strong><br>
          Por favor, tente novamente. Se o problema persistir:
          <ul class="mb-0">
            <li>Verifique sua conexão com a internet</li>
            <li>Tente usar um navegador diferente</li>
            <li>Certifique-se de que não há bloqueadores de pop-up ativos</li>
          </ul>
        `;
        document.getElementById('diarioForm').appendChild(errorMessage);
        
        // Remover o indicador de carregamento em caso de erro
        const loadingIndicator = document.querySelector('.alert-info');
        if (loadingIndicator && document.contains(loadingIndicator)) {
          loadingIndicator.remove();
        }
        
        // Remover mensagem de erro após 10 segundos
        setTimeout(() => {
          if (document.contains(errorMessage)) {
            errorMessage.remove();
          }
        }, 10000);
      }
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
	
	function showFeedbackWithDelay() {
	  setTimeout(() => {
		const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
		feedbackModal.show();
	  }, 1200); // 1.2 segundos de delay
	}

    async function fetchLastUpdate() {
      try {
        const response = await fetch('https://api.github.com/repos/thixgor/Projetos-Acad-micos/commits');
        const commits = await response.json();
        if (commits.length > 0) {
          const lastCommitDate = new Date(commits[0].commit.author.date).toLocaleString('pt-BR');
          document.getElementById('last-update').textContent = lastCommitDate;
        }
      } catch (error) {
        document.getElementById('last-update').textContent = 'Erro ao carregar data';
      }
    }
    fetchLastUpdate();

		// Feedback Handling
	let selectedRating = '';

	document.querySelectorAll('.feedback-btn').forEach(button => {
	  button.addEventListener('click', function() {
		selectedRating = this.dataset.rating;
		document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('active'));
		this.classList.add('active');
	  });
	});

	document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
	  e.preventDefault();
	  
	  const comentario = document.getElementById('comentario').value;
	  const nome = document.getElementById('nome').value.trim();
	  
	  const formData = new FormData();
	  formData.append('entry.85766025', comentario);
	  formData.append('entry.1074346290', nome);
	  formData.append('entry.305852309', selectedRating);
	  
	  try {
		await fetch('https://docs.google.com/forms/d/e/1FAIpQLSfyuOVVkmDGATCm3CiIe3YjG9_jSdMlhj-OfZaosEXsvulN1w/formResponse', {
		  method: 'POST',
		  body: formData,
		  mode: 'no-cors'
		});
		
		// Fechar modal após envio
		bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
		alert('Obrigado pelo seu feedback! 😊');
	  } catch (error) {
		alert('Erro ao enviar feedback. Tente novamente mais tarde.');
	  }
	});

    function handlePDFUpload(event) {
      const files = Array.from(event.target.files);
      
      // Process each file
      files.forEach(file => {
        if (file.name.startsWith('Diário de Campo - ')) {
          const dateStr = file.name.match(/\d{2}-\d{2}-\d{4}/)[0];
          const version = file.name.match(/\(\d+\)/) ? parseInt(file.name.match(/\(\d+\)/)[0].replace(/[()]/g, '')) : 0;
          
          // Check if we already have a file with this date
          const existingIndex = selectedPDFs.findIndex(pdf => pdf.date === dateStr);
          
          if (existingIndex === -1 || version > selectedPDFs[existingIndex].version) {
            const pdfInfo = {
              file: file,
              date: dateStr,
              version: version,
              name: file.name
            };
            
            if (existingIndex !== -1) {
              selectedPDFs[existingIndex] = pdfInfo;
            } else {
              selectedPDFs.push(pdfInfo);
            }
          }
        }
      });
      
      // Sort PDFs by date
      selectedPDFs.sort((a, b) => {
        const dateA = new Date(a.date.split('-').reverse().join('-'));
        const dateB = new Date(b.date.split('-').reverse().join('-'));
        return dateA - dateB;
      });
      
      renderPDFPreview();
    }

    function renderPDFPreview() {
      const preview = document.getElementById('pdfPreview');
      preview.innerHTML = '';
      
      if (selectedPDFs.length === 0) {
        preview.innerHTML = '<p class="text-center text-muted mt-4">Nenhum PDF selecionado</p>';
        return;
      }
      
      selectedPDFs.forEach((pdf, index) => {
        const item = document.createElement('div');
        item.className = 'pdf-item';
        item.innerHTML = `
          <div class="pdf-info">
            <span class="pdf-icon">📄</span>
            <div>
              <div class="pdf-name">${pdf.name}</div>
              <div class="pdf-date">${pdf.date}</div>
            </div>
          </div>
          <button class="remove-pdf" onclick="removePDF(${index})">×</button>
        `;
        preview.appendChild(item);
      });
    }

    function removePDF(index) {
      selectedPDFs.splice(index, 1);
      renderPDFPreview();
    }

    async function mergePDFs() {
      if (selectedPDFs.length === 0) {
        alert('Por favor, selecione pelo menos um PDF para combinar.');
        return;
      }

      try {
        // Certifique-se de que a biblioteca PDF-LIB está disponível
        const PDFLib = window.PDFLib || window.pdfjsLib;
        if (!PDFLib) {
          alert('Erro: A biblioteca PDF-LIB não foi carregada corretamente. Verifique sua conexão com a internet.');
        return;
      }

      const { PDFDocument } = PDFLib;
      const mergedPdf = await PDFDocument.create();
      
        // Mostrar indicador de progresso
        const preview = document.getElementById('pdfPreview');
        const progressDiv = document.createElement('div');
        progressDiv.className = 'alert alert-info';
        progressDiv.textContent = 'Combinando PDFs... Por favor, aguarde.';
        preview.appendChild(progressDiv);
        
        for (const pdfInfo of selectedPDFs) {
          try {
          const pdfBytes = await pdfInfo.file.arrayBuffer();
          const pdf = await PDFDocument.load(pdfBytes);
          const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          copiedPages.forEach((page) => mergedPdf.addPage(page));
            
            // Atualizar progresso
            progressDiv.textContent = `Processando: ${pdfInfo.name}`;
          } catch (error) {
            console.error(`Erro ao processar o PDF ${pdfInfo.name}:`, error);
            // Continuar com o próximo PDF
          }
        }
        
        // Remover indicador de progresso
        preview.removeChild(progressDiv);
        
        const mergedPdfFile = await mergedPdf.save();
        const blob = new Blob([mergedPdfFile], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Diário de Campo Completo.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('PDFs combinados com sucesso!');
      } catch (error) {
        console.error('Erro ao combinar PDFs:', error);
        alert('Ocorreu um erro ao combinar os PDFs. Por favor, tente novamente.');
      }
    }

    function handleBack() {
      const homeVisible = !document.getElementById('home').classList.contains('hidden');
      const createVisible = !document.getElementById('create').classList.contains('hidden');
      const attachVisible = !document.getElementById('attach').classList.contains('hidden');

      if (homeVisible) {
        window.location.href = 'https://thiago.med.br/ferramentas';
      } else if (createVisible || attachVisible) {
        showHomePage();
      }
    }

  </script>
  
  



  </script>
  <footer id="footer">
    <p>Última atualização: <span id="last-update">carregando...</span></p>
  </footer>
</body>
</html>
